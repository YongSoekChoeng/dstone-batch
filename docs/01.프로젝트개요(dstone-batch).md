[Dstone Document Index](../../docs/Index.md)

# dstone-batch 프로젝트 개요

## 1. 프로젝트 소개

`dstone-batch`는 Spring Boot, Spring Batch, Spring Cloud Task를 기반으로 구축된 엔터프라이즈급 배치 애플리케이션 프레임워크입니다. 대용량 데이터 처리를 위한 강력하고 확장 가능한 배치 솔루션을 제공하며, 반복적인 배치 작업 구성을 단순화하고 개발자가 비즈니스 로직에 집중할 수 있도록 설계되었습니다.

주요 특징:
- **표준화된 잡(Job) 개발**: `BaseJobConfig` 추상 클래스를 상속하여 일관된 방식으로 잡을 개발합니다.
- **자동 잡 등록**: `@AutoRegJob` 어노테이션을 사용하여 잡을 자동으로 탐지하고 시스템에 등록합니다.
- **다중 스레드 및 병렬 처리**: `TaskExecutor`와 `SplitFlow`를 활용하여 스텝(Step) 또는 플로우(Flow)를 병렬로 실행하여 처리 성능을 극대화합니다.
- **다양한 데이터 소스 지원**: 여러 데이터베이스 접속 정보(`common`, `sample`)를 설정하여 다양한 데이터 소스와 연동할 수 있습니다.
- **유연한 실행 환경**: 로컬 환경에서의 직접 실행은 물론, Spring Cloud Data Flow와의 연동을 통해 클라우드 환경에서도 손쉽게 잡을 실행하고 관리할 수 있습니다.
- **강화된 설정 관리**: `application.yml`과 `env.properties`를 통해 설정을 분리하고, Jasypt를 이용해 데이터베이스 암호를 암호화하여 보안을 강화합니다.

## 2. 프로젝트 구조

```
dstone-batch/
├── conf/                    # 외부 설정 파일 (application.yml, env.properties)
├── pom.xml                  # Maven 프로젝트 설정 (의존성, 빌드)
└── src/
    ├── main/
    │   ├── java/
    │   │   └── net/dstone/batch/
    │   │       ├── common/          # 프레임워크 공통 핵심 클래스
    │   │       │   ├── DstoneBatchApplication.java # 애플리케이션 메인 클래스
    │   │       │   ├── annotation/    # @AutoRegJob 어노테이션
    │   │       │   ├── config/        # 데이터소스, 트랜잭션 등 주요 설정
    │   │       │   ├── core/          # BaseJobConfig 등 핵심 추상 클래스
    │   │       │   └── runner/        # 잡 실행 클래스 (SimpleBatchRunner)
    │   │       └── sample/          # 샘플 배치 잡 예제
    │   │           └── jobs/
    │   │               ├── job001/    # 샘플 잡 1
    │   │               └── ...
    │   └── resources/
    │       ├── schema/              # Spring Batch 및 Task 테이블 생성 스크립트
    │       └── sqlmap/              # MyBatis 매퍼 XML 파일
    └── test/                      # 테스트 코드
```

- **`conf/`**: `application.yml`, `env.properties`, `log4j2.xml` 등 애플리케이션의 주요 설정을 담고 있습니다. 빌드 시 `target/classes` 경로로 복사됩니다.
- **`pom.xml`**: Spring Boot Starter Batch, Spring Cloud Task, MyBatis, MySQL Connector 등 프로젝트의 의존성을 정의합니다.
- **`src/main/java/net/dstone/batch/common`**: 프레임워크의 핵심 기능이 위치합니다.
  - **`config/`**: `ConfigDatasource.java`, `ConfigTransaction.java` 등 데이터 소스와 트랜잭션 매니저를 설정하는 클래스들이 포함됩니다.
  - **`core/`**: `BaseJobConfig.java`와 같이 모든 잡 설정의 기반이 되는 추상 클래스가 정의되어 있습니다.
  - **`runner/`**: `SimpleBatchRunner.java`는 커맨드 라인 인자를 통해 특정 잡을 실행하는 역할을 합니다.
- **`src/main/java/net/dstone/batch/sample`**: 프레임워크를 활용한 다양한 샘플 잡들이 구현되어 있어, 실제 잡 개발 시 참고할 수 있습니다.
- **`src/main/resources/schema`**: Spring Batch와 Cloud Task가 사용하는 메타데이터 테이블(`BATCH_*`, `TASK_*`)의 DDL 스크립트가 데이터베이스별로 준비되어 있습니다.

## 3. 핵심 개념 및 동작 원리

### 3.1. 잡 (Job) 정의

모든 배치 잡은 `BaseJobConfig` 클래스를 상속하고, `@AutoRegJob` 어노테이션을 클래스에 선언하여 정의합니다.

- **`@AutoRegJob(name = "sampleJob")`**:
  - 이 어노테이션은 클래스가 배치 잡임을 나타냅니다.
  - `name` 속성은 잡의 고유한 이름이 되며, 커맨드 라인에서 이 이름을 사용하여 잡을 실행합니다.
- **`BaseJobConfig`**:
  - 잡을 구성하는 공통적인 기능(JobRepository, TransactionManager 주입, TaskExecutor 빈 생성 등)을 제공합니다.
  - 개발자는 `configJob()` 추상 메서드를 구현하여 잡의 스텝과 플로우를 정의합니다.
- **`configJob()` 메서드**:
  - `addStep()`, `addFlow()`, `addTasklet()` 등의 메서드를 호출하여 잡의 실행 단위를 순서대로 추가합니다.

**예시: `SampleJobConfig.java`**
```java
@Component
@AutoRegJob(name = "sampleJob")
public class SampleJobConfig extends BaseJobConfig {
    @Override
    public void configJob() throws Exception {
        // 1. 간단한 Tasklet 스텝 추가
        this.addStep(this.createStep("01.스텝1"));
        
        // 2. 멀티스레드 청크(Chunk) 기반 스텝 추가
        this.addStep(this.createMultiThreadStep("03.멀티쓰레드스텝1", 20, 5, new SampleItemReader<>(), new SampleItemProcessor(), new SampleItemWriter()));
        
        // 3. 여러 스텝을 묶은 Flow 추가
        this.addFlow(this.createSimpleFlow("04.심플플로우1"));
        
        // 4. 여러 Flow를 병렬로 실행하는 Split Flow 추가
        this.addFlow(this.createSplitFlow("05.스프릿플로우1"));
    }
    // ... 스텝 및 플로우 생성 메서드들 ...
}
```

### 3.2. 잡 실행 과정

1.  **애플리케이션 시작**: `DstoneBatchApplication.main()` 메서드가 실행됩니다.
2.  **`env.properties` 로드**: `setSysProperties()` 메서드가 `env.properties` 파일의 내용을 시스템 프로퍼티로 로드합니다.
3.  **커맨드 라인 인자 확인**: `main()` 메서드는 커맨드 라인 인자(args)가 있는지 확인합니다.
4.  **`SimpleBatchRunner` 호출**: 인자가 존재할 경우, `SimpleBatchRunner.launchJob()`을 호출하여 잡 실행을 위임합니다.
5.  **잡 실행**: `SimpleBatchRunner`는 `JobLauncher`를 사용하여 커맨드 라인에서 `spring.batch.job.names`로 지정된 이름의 잡을 찾아 실행합니다.

## 4. 설정 (Configuration)

### 4.1. `application.yml`

- **서버 포트**: `server.port` (예: 6081)
- **데이터 소스**: `spring.datasource` 아래에 `common`과 `sample` 두 개의 데이터 소스를 HikariCP 커넥션 풀과 함께 설정합니다. DB 접속 정보는 Jasypt로 암호화되어 있습니다.
- **Spring Batch**:
  - `spring.batch.initialize-schema: NEVER`: 애플리케이션 실행 시 배치 관련 테이블을 자동으로 생성하지 않습니다. (필요시 `schema-*.sql` 스크립트로 수동 생성)
  - `spring.batch.job.enabled: true`: 잡 실행을 활성화합니다.
- **Spring Cloud Task/Data Flow**:
  - `spring.cloud.task.initialize-enabled: false`: Task 관련 테이블 자동 생성을 비활성화합니다.
  - `spring.cloud.dataflow.client.server-uri`: 연동할 Data Flow 서버의 주소를 설정합니다.

### 4.2. `env.properties`

- Jasypt 암호화 키(`jasypt.encryptor.password`)와 같이 민감하거나 환경에 따라 달라지는 설정을 정의합니다. 이 파일의 내용은 애플리케이션 시작 시 시스템 프로퍼티로 등록되어 어디서든 참조할 수 있습니다.

## 5. 잡 실행 방법

### 5.1. 로컬에서 직접 실행

JAR 파일을 빌드한 후, `java -jar` 명령어와 함께 `spring.batch.job.names` 프로퍼티를 사용하여 잡을 실행합니다.

```bash
# 1. 프로젝트 빌드
mvn clean package

# 2. sampleJob 실행
java -jar -Dspring.batch.job.names=sampleJob target/dstone-batch-0.0.1-SNAPSHOT.jar

# 3. 다른 잡 실행 (예: tableDataGenType01Job)
java -jar -Dspring.batch.job.names=tableDataGenType01Job target/dstone-batch-0.0.1-SNAPSHOT.jar
```

### 5.2. Spring Cloud Data Flow 연동

1.  빌드된 JAR 파일을 Spring Cloud Data Flow에 `task` 애플리케이션으로 등록합니다.
2.  Data Flow UI 또는 Shell에서 등록된 태스크 정의를 사용하여 태스크(잡)를 실행합니다. 이 방식은 잡의 스케줄링, 모니터링, 관리를 용이하게 합니다.

## 6. 샘플 잡 소개

`src/main/java/net/dstone/batch/sample/jobs/` 경로 아래에 다양한 유형의 샘플 잡이 포함되어 있습니다.

- **`job001` (sampleJob)**: Tasklet, Chunk, Flow, Split 등 프레임워크의 주요 기능을 종합적으로 보여주는 예제입니다.
- **`job002`**: 테이블 데이터를 생성(Insert)하고 삭제(Delete)하는 Tasklet 기반 예제입니다.
- **`job003`**: 테이블 데이터를 업데이트하는 다양한 방식의 예제입니다.
- **`job004`**: 파일 데이터를 생성하는 예제입니다.
- **`job005`**: 파일을 복사하는 예제입니다.
- **`job006`**: 테이블 데이터를 파일로 쓰거나(Table-To-File), 파일 데이터를 테이블로 읽는(File-To-Table) 예제입니다.

이 샘플들을 통해 `dstone-batch` 프레임워크를 활용한 배치 잡 개발 방법을 빠르게 학습할 수 있습니다.
